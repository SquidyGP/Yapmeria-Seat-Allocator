<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Compensatory Sainte-LaguÃ« Seat Allocator</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    textarea { width: 100%; height: 120px; }
    table { border-collapse: collapse; margin-top: 1em; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #f0f0f0; }
  </style>
</head>
<body>
  <h1>Seat Allocation Tool</h1>
  <p>Enter results in the format: <code>Party,Number</code> (one per line).</p>

  <h3>Local Seats</h3>
  <textarea id="localInput">Workers,5
Social Radical,0
Forward,3
Progressive,1
Reform,0
PC,0
Pike,1
Independent,1</textarea>

  <h3>Party List Votes</h3>
  <textarea id="votesInput">Workers,9
Social Radical,8
Forward,5
Progressive,4
Reform,4
PC,3
Pike,2</textarea>

  <h3>List Share of Total Seats</h3>
  <input type="number" id="shareInput" value="0.5" step="0.01" min="0" max="1"> (0.5 = 50%)

  <br><br>
  <button onclick="allocateSeats()">Allocate Seats</button>

  <div id="results"></div>

<script>
function parseInput(text) {
  let data = {};
  text.split("\n").forEach(line => {
    if (line.trim()) {
      let [party, num] = line.split(",");
      data[party.trim()] = parseInt(num.trim(), 10);
    }
  });
  return data;
}

function allocateSeats() {
  const localSeats = parseInput(document.getElementById("localInput").value);
  const votes = parseInput(document.getElementById("votesInput").value);
  const share = parseFloat(document.getElementById("shareInput").value);

  const L = Object.values(localSeats).reduce((a,b)=>a+b,0);
  const T = Math.round(L / (1 - share));
  const P = T - L;

  let c = {};
  Object.keys(votes).forEach(p => c[p] = localSeats[p] || 0);

  for (let i=0; i<P; i++) {
    let priorities = {};
    let maxPi = -1e9;
    Object.keys(votes).forEach(p => {
      priorities[p] = votes[p] / (2*c[p] + 1);
      if (priorities[p] > maxPi) maxPi = priorities[p];
    });
    let contenders = Object.keys(priorities).filter(p => Math.abs(priorities[p] - maxPi) < 1e-9);
    let winner;
    if (contenders.length === 1) {
      winner = contenders[0];
    } else {
      contenders.sort((a,b) => {
        if (votes[b] !== votes[a]) return votes[b] - votes[a];
        if (c[a] !== c[b]) return c[a] - c[b];
        return a.localeCompare(b);
      });
      winner = contenders[0];
    }
    c[winner] += 1;
  }

  let rows = Object.keys(votes).map(p => {
    let local = localSeats[p] || 0;
    let total = c[p];
    let list = total - local;
    return `<tr><td>${p}</td><td>${local}</td><td>${list}</td><td>${total}</td></tr>`;
  });

  document.getElementById("results").innerHTML = `
    <h3>Results</h3>
    <p>Local seats (L): ${L}<br>List seats (P): ${P}<br>Total seats (T): ${T}</p>
    <table>
      <tr><th>Party</th><th>Local</th><th>List</th><th>Total</th></tr>
      ${rows.join("\n")}
    </table>
  `;
}
</script>

</body>
</html>